# https://esphome.io/guides/configuration-types.html#substitutions
substitutions:
  device_name: utility-counter-gate-fan
  device_comment: "SC-EN-I6-RO4 Utility Pulse Counter and Garage Gate Fan Controller"
  target_temperature_high: "28.0" # ~80F

# https://esphome.io/guides/configuration-types.html#packages
packages:
  norvi: !include templates/norvi-enet-ae06-r.yaml

# https://esphome.io/components/sensor/
sensor:

  # https://esphome.io/components/sensor/dallas.html
  - platform: dallasng
    address: 0xC7012026F75E6028
    name: ${device_name}_temp
    id: temp
    resolution: 12
    # https://esphome.io/components/sensor/index.html#sliding-window-moving-average
    filters:
      - filter_out: nan
      - sliding_window_moving_average:
          window_size: 3
          send_every: 3
          send_first_at: 3

  # https://esphome.io/components/sensor/pulse_meter.html
  # https://esphome.io/components/sensor/pulse_counter.html
  # Device class, icon, and accuracy are not inherited from main sensor, manually repeat
  # https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes
  # https://developers.home-assistant.io/docs/core/entity/sensor/#available-state-classes
  # Water and Gas device class does not support flow rates
  - platform: pulse_counter
    pin:
      # Use input 0 for water
      number: GPIO21
      inverted: true
    update_interval: 60s
    use_pcnt: false
    count_mode:
      rising_edge: DISABLE
      falling_edge: INCREMENT
    internal_filter: 100ms
    unit_of_measurement: 'gal/min'
    name: ${device_name}_water_meter
    icon: 'mdi:water'
    # device_class: 'water'
    # state_class: 'measurement'
    filters:
      - multiply: 10
    total:
      name: ${device_name}_water_meter_total
      icon: 'mdi:water'
      device_class: 'water'
      state_class: 'total_increasing'
      id: water_total
      unit_of_measurement: 'gal'
      filters:
        - multiply: 10

  - platform: pulse_counter
    pin:
      # Use input 1 for gas
      number: GPIO14
      inverted: true
    update_interval: 60s
    use_pcnt: false
    count_mode:
      rising_edge: DISABLE
      falling_edge: INCREMENT
    internal_filter: 100ms
    unit_of_measurement: 'ft³/min'
    name: ${device_name}_gas_meter
    icon: 'mdi:fire'
    # device_class: 'gas'
    # state_class: 'measurement'
    filters:
      - multiply: 10
    total:
      name: ${device_name}_gas_meter_total
      icon: 'mdi:fire'
      device_class: 'gas'
      state_class: 'total_increasing'
      id: gas_total
      unit_of_measurement: 'ft³'
      filters:
      - multiply: 10

  # https://esphome.io/components/sensor/template.html
  - platform: template
    name: ${device_name}_water_meter_total_m3
    icon: 'mdi:water'
    device_class: 'water'
    state_class: 'total_increasing'
    accuracy_decimals: 3
    unit_of_measurement: 'm³'
    # Convert gal to m³ 
    lambda: |-
      return id(water_total).state / 264.2;

  - platform: template
    name: ${device_name}_gas_meter_total_m3
    icon: 'mdi:fire'
    device_class: 'gas'
    state_class: 'total_increasing'
    accuracy_decimals: 3
    unit_of_measurement: 'm³'
    # Convert ft³ to m³
    lambda: |-
      return id(gas_total).state / 35.315;

# https://esphome.io/components/climate
climate:

  # https://esphome.io/components/climate/thermostat.html
  - platform: thermostat
    name: ${device_name}_thermostat
    id: thermo
    sensor: temp
    min_cooling_off_time: 60s
    min_cooling_run_time: 60s
    min_idle_time: 60s
    cool_action:
      - logger.log: "Thermostat : Cool Action, Turning Relay On."
      - switch.turn_on: relay_0
    idle_action:
      - logger.log: "Thermostat : Idle Action, Turning Relay Off."
      - switch.turn_off: relay_0
    default_preset: Default
    preset:
      - name: Default
        default_target_temperature_high: ${target_temperature_high}
    visual:
      min_temperature: 20.0
      max_temperature: 40.0
      temperature_step: 0.5
