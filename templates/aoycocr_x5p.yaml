---
  # Based on https://esphome-configs.io/devices/aoycocr-x10s/

  # https://esphome.io/components/esphome.html
  esphome:
    name: ${device_name}
    comment: ${device_comment}
    platform: ESP8266
    board: esp01_1m
    esp8266_restore_from_flash: true

  # https://esphome.io/components/binary_sensor/index.html
  binary_sensor:

    # https://esphome.io/components/binary_sensor/gpio.html
    - platform: gpio
      name: ${device_name}_button
      device_class: power
      pin:
        number: GPIO13
        inverted: true
      on_press:
        - switch.toggle: relay

    # https://esphome.io/components/binary_sensor/status.html
    - platform: status
      name: ${device_name}_status

  # https://esphome.io/components/sensor/index.html    
  sensor:

    # https://esphome.io/components/sensor/wifi_signal.html
    - platform: wifi_signal
      name: ${device_name}_wifi_signal
      update_interval: 60s

    # https://esphome.io/components/sensor/uptime.html  
    - platform: uptime
      name: ${device_name}_uptime
      unit_of_measurement: minutes
      filters:
        - lambda: return x / 60.0;

  # https://esphome.io/components/text_sensor/index.html
  text_sensor:

    # https://esphome.io/components/text_sensor/version.html
    - platform: version
      name: ${device_name}_version

  # https://esphome.io/components/switch/index.html
  switch:

    # https://esphome.io/components/switch/gpio.html
    - platform: gpio
      name: ${device_name}_relay
      id: relay
      pin: GPIO15
      restore_mode: RESTORE_DEFAULT_OFF
      on_turn_on:
        - light.turn_on:
            id: blue_led
            brightness: 100%
      on_turn_off:
        - light.turn_off: blue_led

  # https://esphome.io/components/output/index.html
  output:

    # https://esphome.io/components/output/esp8266_pwm.html
    - platform: esp8266_pwm
      id: red_output
      pin: GPIO0
      inverted: true
    
    - platform: esp8266_pwm
      id: blue_output
      pin: GPIO2
      inverted: true

  # https://esphome.io/components/light/index.html
  light:
    
    # https://esphome.io/components/light/monochromatic.html
    - platform: monochromatic
      name: ${device_name}_red_led
      id: red_led
      output: red_output
      restore_mode: ALWAYS_OFF
      effects:
        - strobe:
        - flicker:
            alpha: 50%
            intensity: 50%
        - lambda:
            name: throb
            update_interval: 1s
            lambda: |-
              static int state = 0;
              auto call = id(red_led).turn_on();
              // Transtion of 1000ms = 1s
              call.set_transition_length(1000);
              if (state == 0) {
                call.set_brightness(1.0);
              } else {
                call.set_brightness(0.01);
              }
              call.perform();
              state += 1;
              if (state == 2)
                state = 0;

    - platform: monochromatic
      name: ${device_name}_blue_led
      id: blue_led
      output: blue_output
      restore_mode: ALWAYS_OFF
      effects:
        - strobe:
        - flicker:
            alpha: 50%
            intensity: 50%
        - lambda:
            name: throb
            update_interval: 1s
            lambda: |-
              static int state = 0;
              auto call = id(blue_led).turn_on();
              // Transtion of 1000ms = 1s
              call.set_transition_length(1000);
              if (state == 0) {
                call.set_brightness(1.0);
              } else {
                call.set_brightness(0.01);
              }
              call.perform();
              state += 1;
              if (state == 2)
                state = 0;

  # https://esphome.io/guides/automations.html#interval
  interval:
    - interval: 500ms
      then:
        # https://esphome.io/guides/automations.html#if-action
        - if:
            condition:
              not:
                wifi.connected:
            then:
              - light.turn_on:
                  id: red_led
                  brightness: 100%
                  transition_length: 0s
              - delay: 250ms
              - light.turn_off:
                  id: red_led
                  transition_length: 250ms
